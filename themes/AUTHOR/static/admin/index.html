<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jeffrey A. Zyjeski CMS</title>
    
    <!-- Include the styles for the Static CMS UI -->
    <link rel="stylesheet" href="https://unpkg.com/@staticcms/app@^2.0.0/dist/main.css" />
    
    <!-- Auth0 SDK -->
    <script src="https://cdn.auth0.com/js/auth0/9.19.0/auth0.min.js"></script>
    
    <!-- Custom styles for the admin interface -->
    <style>
      :root {
        --primary-color: #6E0DD0;
        --secondary-color: #00F5D4;
        --tertiary-color: #FF9933;
        --text-color: #E0E0E0;
        --background-color: #000F08;
      }
      
      body {
        background-color: var(--background-color);
        background-image: 
          radial-gradient(circle at 20% 30%, #2D0F54 0%, transparent 20%),
          radial-gradient(circle at 80% 70%, #000000 0%, transparent 20%);
        background-attachment: fixed;
      }
      
      .login-page {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      
      .login-container {
        background: rgba(26, 26, 46, 0.9);
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 0 20px rgba(110, 13, 208, 0.5);
        max-width: 400px;
        width: 90%;
        text-align: center;
      }
      
      .site-logo {
        font-family: 'Courier New', monospace;
        font-size: 1.2rem;
        color: var(--secondary-color);
        margin: 1rem 0;
        text-align: center;
        letter-spacing: 2px;
        text-transform: uppercase;
      }
      
      h2 {
        color: white;
        margin-top: 1.5rem;
      }
      
      .login-button {
        background: linear-gradient(90deg, #6E0DD0, #00F5D4);
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        margin-top: 1.5rem;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s;
      }
      
      .login-button:hover {
        transform: translateY(-3px);
      }
      
      #cms-root {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- Login Page -->
    <div id="login-page" class="login-page">
      <div class="login-container">
        <div class="site-logo">
          Jeffrey A. Zyjeski<br>
          Neuro-Digital Enlightenment CMS
        </div>
        <h2>Admin Login</h2>
        <button id="login-button" class="login-button">Login with Auth0</button>
      </div>
    </div>
    
    <!-- CMS Root -->
    <div id="cms-root"></div>
    
    <!-- Static CMS script -->
    <script src="https://unpkg.com/@staticcms/app@^2.0.0/dist/static-cms-app.js"></script>
    
    <script>
      // Wait for DOM content to load
      document.addEventListener('DOMContentLoaded', function() {
        // Auth0 configuration
        const auth0Client = new auth0.WebAuth({
          domain: 'dev-cj5f52kzudnipqoz.us.auth0.com',
          clientID: '0RPDm2aPHynvpsCAMMa9XGtaUYae7xFd',
          responseType: 'token id_token',
          redirectUri: window.location.origin + '/admin/',
          scope: 'openid profile email'
        });
        
        // Login button event
        document.getElementById('login-button').addEventListener('click', function() {
          auth0Client.authorize();
        });
        
        // Check for Auth0 authentication result
        function handleAuth() {
          if (window.location.hash) {
            auth0Client.parseHash(function(err, authResult) {
              if (authResult && authResult.accessToken && authResult.idToken) {
                // Store tokens
                localStorage.setItem('auth0_access_token', authResult.accessToken);
                localStorage.setItem('auth0_id_token', authResult.idToken);
                localStorage.setItem('auth0_expires_at', new Date().getTime() + authResult.expiresIn * 1000);
                
                // Get user profile
                auth0Client.client.userInfo(authResult.accessToken, function(err, user) {
                  if (!err) {
                    localStorage.setItem('auth0_user', JSON.stringify(user));
                    
                    // Clear URL hash
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Initialize CMS
                    initCMS();
                  }
                });
              } else if (err) {
                console.error('Auth0 error:', err);
                alert('Login failed. Please try again.');
              }
            });
          } else {
            // Check for existing session
            const accessToken = localStorage.getItem('auth0_access_token');
            const expiresAt = localStorage.getItem('auth0_expires_at');
            
            if (accessToken && expiresAt && new Date().getTime() < parseInt(expiresAt)) {
              // Session still valid
              initCMS();
            }
          }
        }
        
        // Initialize CMS with Auth0 token
        function initCMS() {
          // Hide login page
          document.getElementById('login-page').style.display = 'none';
          
          // Show CMS root
          document.getElementById('cms-root').style.display = 'block';
          
          // Initialize the CMS
          window.CMS.init({
            config: {
              backend: {
                name: 'git-gateway',
                branch: 'main',
                auth_token: localStorage.getItem('auth0_id_token'),
                accept_roles: ['admin', 'editor']
              },
              media_folder: 'static/images/uploads',
              public_folder: '/images/uploads',
              // Add your collections config here - these match your existing config.yml
              collections: [
                {
                  name: 'books',
                  label: 'Books',
                  folder: 'content/books',
                  create: true,
                  slug: '{{slug}}',
                  fields: [
                    {label: 'Title', name: 'title', widget: 'string'},
                    {label: 'Date', name: 'date', widget: 'datetime'},
                    {label: 'Draft', name: 'draft', widget: 'boolean', default: false},
                    {label: 'Cover Image', name: 'cover_image', widget: 'image', required: false},
                    {label: 'Series', name: 'series', widget: 'string', required: false},
                    {label: 'Pages', name: 'pages', widget: 'number', required: false},
                    {label: 'Publication Date', name: 'publication_date', widget: 'string', required: false},
                    {label: 'Show 3D Transition', name: 'show_3d_transition', widget: 'boolean', default: false},
                    {label: 'Tags', name: 'tags', widget: 'list', required: false},
                    {label: 'Body', name: 'body', widget: 'markdown'}
                  ]
                },
                {
                  name: 'stories',
                  label: 'Koans',
                  folder: 'content/stories',
                  create: true,
                  slug: '{{slug}}',
                  fields: [
                    {label: 'Title', name: 'title', widget: 'string'},
                    {label: 'Date', name: 'date', widget: 'datetime'},
                    {label: 'Draft', name: 'draft', widget: 'boolean', default: false},
                    {label: 'Koan Text', name: 'koan_text', widget: 'text'},
                    {label: 'Tags', name: 'tags', widget: 'list', required: false},
                    {label: 'Body', name: 'body', widget: 'markdown'}
                  ]
                },
                {
                  name: 'audio',
                  label: 'Simulations',
                  folder: 'content/audio',
                  create: true,
                  slug: '{{slug}}',
                  fields: [
                    {label: 'Title', name: 'title', widget: 'string'},
                    {label: 'Date', name: 'date', widget: 'datetime'},
                    {label: 'Draft', name: 'draft', widget: 'boolean', default: false},
                    {label: 'Audio File', name: 'audio_file', widget: 'file', required: false},
                    {label: 'Transcript', name: 'transcript', widget: 'markdown', required: false},
                    {label: 'Tags', name: 'tags', widget: 'list', required: false},
                    {label: 'Body', name: 'body', widget: 'markdown'}
                  ]
                },
                {
                  name: 'posts',
                  label: 'Dharma Log',
                  folder: 'content/posts',
                  create: true,
                  slug: '{{slug}}',
                  fields: [
                    {label: 'Title', name: 'title', widget: 'string'},
                    {label: 'Date', name: 'date', widget: 'datetime'},
                    {label: 'Draft', name: 'draft', widget: 'boolean', default: false},
                    {label: 'Tags', name: 'tags', widget: 'list', required: false},
                    {label: 'Body', name: 'body', widget: 'markdown'}
                  ]
                }
              ]
            }
          });
        }
        
        // Initialize the app
        handleAuth();
      });
    </script>
  </body>
</html>