<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jeffrey A. Zyjeski CMS</title>
    
    <!-- Include the styles for the Decap CMS UI -->
    <link rel="stylesheet" href="https://unpkg.com/@staticcms/app@^2.0.0/dist/main.css" />
    
    <!-- Custom styles for the admin interface -->
    <style>
      /* Your styles here */
    </style>
  </head>
  <body>
    <!-- Display a custom logo/text before the CMS loads -->
    <div class="site-logo">
      Jeffrey A. Zyjeski<br>
      Neuro-Digital Enlightenment CMS
    </div>
    
    <!-- Include the Decap CMS -->
    <script src="https://unpkg.com/@staticcms/app@^2.0.0/dist/static-cms-app.js"></script>
    
    <!-- Auth0 backend registration -->
    <script>
      // Create an Auth0 backend class
      class Auth0Backend {
        constructor(config) {
          this.config = config;
        }
        
        login() {
          // Redirect to Auth0's login page
          const auth0Domain = this.config.domain;
          const auth0ClientID = this.config.clientID;
          const callbackURL = encodeURIComponent(`${window.location.origin}/admin/`);
          const auth0State = Date.now().toString();
          localStorage.setItem('auth0State', auth0State);
          
          const authURL = `https://${auth0Domain}/authorize?client_id=${auth0ClientID}&redirect_uri=${callbackURL}&response_type=token%20id_token&scope=openid%20profile%20email&state=${auth0State}&nonce=${Date.now()}`;
          
          window.location.href = authURL;
        }
        
        restoreUser() {
          // Check if we have a token in the URL (after Auth0 redirect)
          const hashParams = new URLSearchParams(
            window.location.hash.substring(1)
          );
          
          if (hashParams.has('access_token') && hashParams.has('id_token')) {
            const accessToken = hashParams.get('access_token');
            const idToken = hashParams.get('id_token');
            
            // Clear the hash to remove tokens from URL
            history.replaceState(null, null, ' ');
            
            // Return user data
            return Promise.resolve({
              token: accessToken,
              id_token: idToken
            });
          }
          
          return Promise.resolve(null);
        }
        
        logout() {
          // Implement logout by clearing tokens
          // Optionally redirect to Auth0 logout
          const auth0Domain = this.config.domain;
          const clientId = this.config.clientID;
          const returnToURL = encodeURIComponent(`${window.location.origin}/admin/`);
          
          window.location.href = `https://${auth0Domain}/v2/logout?client_id=${clientId}&returnTo=${returnToURL}`;
          
          return Promise.resolve();
        }
        
        getToken() {
          // Return token from localStorage
          const hashParams = new URLSearchParams(
            window.location.hash.substring(1)
          );
          
          if (hashParams.has('access_token')) {
            return hashParams.get('access_token');
          }
          
          return null;
        }
      }
      
      // Register the Auth0 backend constructor
      window.CMS.registerBackend('auth0', Auth0Backend);
    </script>
    
    <script>
      // Initialize the CMS
      window.CMS.init();
    </script>
  </body>
</html>